package com.cw.aibot.service;

import com.cw.aibot.DTO.JudgeResult;
import com.cw.aibot.DTO.RawTopic;
import com.cw.aibot.entity.Board;
import com.cw.aibot.entity.Persona;
import com.cw.aibot.repository.BoardRepository;
import com.cw.aibot.repository.PersonaRepository;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.Duration;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Random;

@Slf4j
@Service
@RequiredArgsConstructor
public class AiPostGenerationService {
    private final AiService aiService;
    private final PersonaRepository personaRepo;
    private final BoardRepository boardRepo;
    private final SimilarityService similarityService;
    private final JdbcTemplate jdbcTemplate;
    private final Random random = new Random();
    private final ObjectMapper objectMapper = new ObjectMapper();

    @Transactional
    public Board generateShockingPost(RawTopic topic) {
        List<Persona> personas = personaRepo.findAll();
        if (personas.isEmpty()) return null;
        Persona writer = personas.get(random.nextInt(personas.size()));

        // ===== STEP 1: ë³¸ë¬¸ ìƒì„± (ê°„ê²°í•œ í”„ë¡¬í”„íŠ¸) =====
        String contentTask = String.format("""
            ë„ˆëŠ” ì»¤ë®¤ë‹ˆí‹° ê³ ì¸ë¬¼ ì½˜í…ì¸  ì‘ê°€ %së‹¤.
            ì£¼ì œ: %s
            ì¶œì²˜: %s

            ê·œì¹™:
            - ì»¤ë®¤ë‹ˆí‹° ê³ ì¸ë¬¼ êµ¬ì–´ì²´ë¡œ 500ì ì´ìƒ ì‘ì„±
            - "ã„¹ã…‡","ì‹¤í™”ëƒ","ëŒ€ë°•","ê²½ì•…","ã„·ã„·","í—" ì‚¬ìš©ê¸ˆì§€
            - ë°°ê²½ì§€ì‹+ì‚¬íšŒì ë§¥ë½+ì°¬ë°˜ì‹œê° í¬í•¨
            - ë§ˆí¬ë‹¤ìš´(#,*,-) ê¸ˆì§€

            ì¶œë ¥í˜•ì‹:
            [TITLE]
            ì œëª©
            [CONTENT]
            ë³¸ë¬¸
            """, writer.getName(), topic.getTitle(), topic.getLink());

        String rawContent = aiService.askGpt("", writer.getPrompt(), contentTask);
        if (rawContent == null || !rawContent.contains("[TITLE]") || !rawContent.contains("[CONTENT]")) {
            log.warn("âš ï¸ ë³¸ë¬¸ ìƒì„± í˜•ì‹ ì˜¤ë¥˜, ì¬ì‹œë„...");
            rawContent = aiService.askGpt("", writer.getPrompt(),
                    "ë°˜ë“œì‹œ [TITLE]ê³¼ [CONTENT] íƒœê·¸ë¥¼ í¬í•¨í•´ë¼.\n" + contentTask);
            if (rawContent == null || !rawContent.contains("[TITLE]")) {
                log.error("âŒ ë³¸ë¬¸ ìƒì„± ì‹¤íŒ¨");
                return null;
            }
        }

        String title = extract(rawContent, "[TITLE]", "[CONTENT]").trim();
        String content = extract(rawContent, "[CONTENT]", null).trim();

        // ê¸ˆì§€ í‘œí˜„ í•„í„°
        if (containsBannedPhrases(title + " " + content)) {
            log.warn("ğŸš« ê¸ˆì§€ í‘œí˜„ ê°ì§€, ì •ì œ ì¤‘...");
            content = cleanBannedPhrases(content);
            title = cleanBannedPhrases(title);
        }

        // ì»¨í…ì¸  ê¸¸ì´ ê²€ì¦
        if (content.length() < 400) {
            log.warn("âš ï¸ ì»¨í…ì¸  {}ì, ë³´ê°• ìš”ì²­...", content.length());
            String boosted = aiService.askGpt("", "",
                    "ë‹¤ìŒ ê¸€ì„ 500ì ì´ìƒìœ¼ë¡œ í™•ì¥í•´. êµ¬ì–´ì²´ ìœ ì§€. ë§ˆí¬ë‹¤ìš´ ê¸ˆì§€.\nì›ë¬¸: " + content);
            if (boosted != null && !boosted.startsWith("ERROR") && boosted.length() > content.length()) {
                content = boosted.replaceAll("[#*\\-]", "");
            }
        }

        // ===== STEP 2: ìˆì¸  ëŒ€ë³¸ ìƒì„± (ë³„ë„ í˜¸ì¶œ, ê°„ê²°) =====
        String shortsTask = String.format("""
            ë‹¤ìŒ ê¸€ì„ 60ì´ˆ ìˆì¸  ëŒ€ë³¸ 4íŒŒíŠ¸ë¡œ ë³€í™˜í•´.
            ì œëª©: %s
            ë‚´ìš©ìš”ì•½: %s

            ë§íˆ¬: ì»¤ë®¤ë‹ˆí‹° ê³ ì¸ë¬¼ êµ¬ì–´ì²´. "ì™€ ë‹˜ë“¤ ê·¸ê±° ì•”?", "ì´ê²Œ ì†Œë¦„ ë‹ëŠ” ê²Œ ë­ëƒë©´" ìŠ¤íƒ€ì¼.
            ê¸ˆì§€ì–´: ã„¹ã…‡, ì‹¤í™”ëƒ, ëŒ€ë°•, ê²½ì•…, ã„·ã„·, í—
            1.25x ì†ë„ ê¸°ì¤€ ë¶„ëŸ‰.

            ì¶œë ¥í˜•ì‹(íƒœê·¸ í•„ìˆ˜):
            [INTRO]
            0-5ì´ˆ í›„í‚¹
            [BODY_1]
            5-25ì´ˆ í•µì‹¬íŒ©íŠ¸
            [BODY_2]
            25-45ì´ˆ ë°˜ì „+ëŒ“ê¸€ë°˜ì‘2ê°œ
            [OUTRO]
            45-60ì´ˆ ëŒ“ê¸€ìœ ë„ ë§ˆë¬´ë¦¬
            """, title, content.substring(0, Math.min(300, content.length())));

        String rawShorts = aiService.askGpt("", "", shortsTask);

        String intro, body1, body2, outro;
        if (rawShorts != null && rawShorts.contains("[INTRO]") && rawShorts.contains("[BODY_1]")) {
            intro = extract(rawShorts, "[INTRO]", "[BODY_1]").trim();
            body1 = extract(rawShorts, "[BODY_1]", "[BODY_2]").trim();
            body2 = extract(rawShorts, "[BODY_2]", "[OUTRO]").trim();
            outro = extract(rawShorts, "[OUTRO]", null).trim();
        } else {
            // ìë™ ë¶„ì ˆ fallback
            log.warn("âš ï¸ ìˆì¸  íƒœê·¸ ëˆ„ë½, ìë™ ë¶„ì ˆ ì ìš©");
            String fallback = rawShorts != null && !rawShorts.startsWith("ERROR") ? rawShorts : content;
            intro = "ì™€ ë‹˜ë“¤, " + title + " ì´ê±° ì¢€ ì•Œì•„ì•¼ ë¨";
            int len = fallback.length();
            body1 = fallback.substring(0, Math.min(len / 2, 300));
            body2 = fallback.substring(Math.min(len / 2, 300), Math.min(len, 600));
            outro = "ë‹˜ë“¤ì€ ì–´ë–»ê²Œ ìƒê°í•¨? ëŒ“ê¸€ë¡œ ì•Œë ¤ì¤˜. êµ¬ë… ì¢‹ì•„ìš”ë„ ë¶€íƒ!";
        }

        // ê¸ˆì§€ì–´ ìµœì¢… ì •ì œ
        intro = cleanBannedPhrases(intro);
        body1 = cleanBannedPhrases(body1);
        body2 = cleanBannedPhrases(body2);
        outro = cleanBannedPhrases(outro);

        // JSON ë¹Œë“œ (visual + audio ë©”íƒ€ í¬í•¨)
        String shortsScript = buildTimelineJson(intro, body1, body2, outro);

        if (similarityService.isTooSimilar(title + " " + content)) {
            log.warn("ğŸ”„ ìœ ì‚¬ ê²Œì‹œê¸€ ì¡´ì¬: {}", topic.getTitle());
            return null;
        }

        Board board = Board.builder()
                .pId(writer.getPId())
                .category(topic.getCategory())
                .title(title.replaceAll("[#*]", ""))
                .content(content.replaceAll("[#*\\-]", ""))
                .shortsScript(shortsScript)
                .writer(writer.getName())
                .hit(random.nextInt(100))
                .sourceUrl(topic.getLink())
                .contentHash(topic.getContentHash())
                .build();

        Board saved = boardRepo.save(board);

        // ===== PR-JUDGE: 2ë‹¨ê³„ ê²Œì´íŠ¸ (pre_score â†’ judge_llm) =====
        int preScore = calculatePreScore(saved, topic);
        log.info("ğŸ“Š pre_score={} (70 ì´ìƒ â†’ LLM ì‹¬ì‚¬)", preScore);

        if (preScore >= 70) {
            JudgeResult judgeResult = judgeWithLLM(saved, preScore);

            if ("PASS".equals(judgeResult.getVerdict())) {
                String videoType = determineVideoType(topic.getCategory());
                String riskFlagsJson = judgeResult.getRiskFlags() != null
                    ? String.join(",", judgeResult.getRiskFlags()) : "";

                String sql = """
                    INSERT INTO shorts_queue
                    (bno, status, video_type, quality_score, priority, reg_date,
                     judge_verdict, judge_score, judge_angle, risk_flags)
                    VALUES (?, 0, ?, 5.0, 5, SYSDATE, ?, ?, ?, ?)
                    """;
                jdbcTemplate.update(sql, saved.getBno(), videoType,
                    judgeResult.getVerdict(), judgeResult.getScore(),
                    judgeResult.getAngle(), riskFlagsJson);

                log.info("âœ… ì‹¬ì‚¬ í†µê³¼ (PASS): BNO={} | {} | ì ìˆ˜={} | ì•µê¸€={}",
                    saved.getBno(), title, judgeResult.getScore(), judgeResult.getAngle());
            } else {
                log.warn("ğŸš« ì‹¬ì‚¬ íƒˆë½ ({}): BNO={} | ì‚¬ìœ ={}",
                    judgeResult.getVerdict(), saved.getBno(), judgeResult.getReason());
            }
        } else {
            log.warn("âš ï¸ pre_score ë¯¸ë‹¬ ({}): BNO={} | shorts_queue ì œì™¸", preScore, saved.getBno());
        }

        return saved;
    }

    private String buildTimelineJson(String intro, String body1, String body2, String outro) {
        return String.format(
                "{\"timeline\":[" +
                "{\"section\":\"intro\",\"start_sec\":0,\"end_sec\":5,\"text\":\"%s\"}," +
                "{\"section\":\"body_1\",\"start_sec\":5,\"end_sec\":25,\"text\":\"%s\"}," +
                "{\"section\":\"body_2\",\"start_sec\":25,\"end_sec\":45,\"text\":\"%s\"}," +
                "{\"section\":\"outro\",\"start_sec\":45,\"end_sec\":60,\"text\":\"%s\"}" +
                "]," +
                "\"visual\":{\"theme\":\"dark_cinematic\",\"caption_highlight\":\"#FFD100\",\"caption_base\":\"#FFFFFF\",\"font\":\"Pretendard\",\"no_red_bg\":true}," +
                "\"audio\":{\"voice_speed\":1.25,\"tone\":\"energetic\",\"avoid\":\"news_anchor_robotic\"}" +
                "}",
                escapeJson(intro), escapeJson(body1), escapeJson(body2), escapeJson(outro));
    }

    private boolean containsBannedPhrases(String text) {
        if (text == null) return false;
        String[] banned = {"ã„¹ã…‡", "ì‹¤í™”ëƒ", "ì‹¤í™”ì„", "ì‹¤í™”ì¸", "ëŒ€ë°•", "ê²½ì•…", "ã„·ã„·ã„·", "í—ã…‹"};
        for (String b : banned) {
            if (text.contains(b)) return true;
        }
        return false;
    }

    private String cleanBannedPhrases(String text) {
        if (text == null) return "";
        return text.replace("ã„¹ã…‡", "ì •ë§")
                   .replace("ì‹¤í™”ëƒ", "ì‚¬ì‹¤ì¸ê°€")
                   .replace("ì‹¤í™”ì„", "ì‚¬ì‹¤ì„")
                   .replace("ì‹¤í™”ì¸", "ì‚¬ì‹¤ì¸")
                   .replace("ëŒ€ë°•", "ë†€ë¼ìš´")
                   .replace("ê²½ì•…", "ì¶©ê²©ì ì¸")
                   .replace("ã„·ã„·ã„·", "")
                   .replace("í—ã…‹", "")
                   .replaceAll("[#*]", "");
    }

    private String determineVideoType(String category) {
        if (category == null) return "INFO";
        if (category.contains("ì—°ì˜ˆ") || category.contains("ìŠ¤í¬ì¸ ")) return "ENTERTAINMENT";
        if (category.contains("í…Œí¬") || category.contains("ê³¼í•™")) return "INFO";
        if (category.contains("ì‚¬íšŒ") || category.contains("íŠ¸ë Œë“œ")) return "TREND";
        if (category.contains("ì»¤ë®¤ë‹ˆí‹°") || category.contains("ìƒí™œ")) return "COMMUNITY";
        return "INFO";
    }

    private String extract(String text, String start, String end) {
        int s = text.indexOf(start);
        if (s == -1) return "";
        s += start.length();
        if (end == null) return text.substring(s).trim();
        int e = text.indexOf(end, s);
        return (e == -1) ? text.substring(s).trim() : text.substring(s, e).trim();
    }

    private String escapeJson(String s) {
        if (s == null) return "";
        return s.replace("\\", "\\\\")
                .replace("\"", "\\\"")
                .replace("\n", "\\n")
                .replace("\r", "")
                .replace("\t", "\\t");
    }

    // ===== PR-JUDGE: ê°ë³„ì‚¬ AI =====

    /**
     * STEP 1: ê·œì¹™ ê¸°ë°˜ pre_score (0-100)
     */
    private int calculatePreScore(Board board, RawTopic topic) {
        int score = 0;

        // 1. ì œëª© í’ˆì§ˆ (0-20ì )
        String title = board.getTitle();
        if (title != null) {
            int titleLen = title.length();
            if (titleLen >= 20 && titleLen <= 60) score += 15;
            else if (titleLen >= 10) score += 10;

            // ì œëª©ì— í‚¤ì›Œë“œ í¬í•¨ ì‹œ ê°€ì‚°
            if (title.matches(".*[AI|í…Œí¬|ìŠ¤íƒ€íŠ¸ì—…|ì˜¤í”ˆì†ŒìŠ¤|ê°œë°œì|í”„ë¡œê·¸ë˜ë¨¸].*")) score += 5;
        }

        // 2. ë³¸ë¬¸ í’ˆì§ˆ (0-30ì )
        String content = board.getContent();
        if (content != null) {
            int contentLen = content.length();
            if (contentLen >= 500) score += 20;
            else if (contentLen >= 300) score += 15;
            else if (contentLen >= 200) score += 10;

            // êµ¬ì²´ì  ì •ë³´ í¬í•¨ ì‹œ ê°€ì‚°
            if (content.contains("ì¶œì²˜") || content.contains("ë§í¬") || content.contains("ë°œí‘œ")) score += 5;
            if (content.contains("CEO") || content.contains("ê³µì‹") || content.contains("ë°œí‘œ")) score += 5;
        }

        // 3. ì¶œì²˜ ì‹ ë¢°ë„ (0-20ì )
        String sourceUrl = board.getSourceUrl();
        if (sourceUrl != null && !sourceUrl.isEmpty()) {
            if (sourceUrl.contains("techcrunch") || sourceUrl.contains("venturebeat")
                || sourceUrl.contains("theverge") || sourceUrl.contains("zdnet")) {
                score += 20;
            } else if (sourceUrl.contains("github") || sourceUrl.contains("medium")
                || sourceUrl.contains("reddit")) {
                score += 15;
            } else {
                score += 10;
            }
        }

        // 4. ì¡°íšŒìˆ˜ (0-10ì )
        int hit = board.getHit();
        if (hit >= 50) score += 10;
        else if (hit >= 20) score += 7;
        else if (hit >= 10) score += 5;

        // 5. ì‹œì˜ì„± (0-10ì )
        LocalDateTime regDate = board.getRegDate();
        if (regDate != null) {
            Duration gap = Duration.between(regDate, LocalDateTime.now());
            long hours = gap.toHours();
            if (hours <= 24) score += 10;
            else if (hours <= 72) score += 7;
            else if (hours <= 168) score += 5;
        } else {
            score += 5; // ê¸°ë³¸ê°’
        }

        // 6. ì¹´í…Œê³ ë¦¬ ê°€ì¤‘ì¹˜ (0-10ì )
        String category = board.getCategory();
        if (category != null) {
            if (category.contains("í…Œí¬") || category.contains("ê³¼í•™")) score += 10;
            else if (category.contains("íŠ¸ë Œë“œ") || category.contains("ì‚¬íšŒ")) score += 7;
            else score += 5;
        }

        return Math.min(100, score);
    }

    /**
     * STEP 2: LLM ê¸°ë°˜ ìµœì¢… ì‹¬ì‚¬ (pre_score >= 70)
     */
    private JudgeResult judgeWithLLM(Board board, int preScore) {
        String judgePrompt = String.format("""
            ë‹¹ì‹ ì€ ìˆì¸  ì½˜í…ì¸  ì‹¬ì‚¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
            ë‹¤ìŒ ê¸€ì´ 'ë–¡ë°¥í˜• ìˆì¸ 'ë¡œ ì í•©í•œì§€ íŒë‹¨í•˜ì„¸ìš”.

            ì œëª©: %s
            ë³¸ë¬¸: %s
            ì¶œì²˜: %s
            pre_score: %d/100

            íŒë‹¨ ê¸°ì¤€:
            1. ë…¼ìŸ ìœ ë°œ ê°€ëŠ¥ì„± (ì°¬ë°˜ ë…¼ë€, ì˜ê²¬ ëŒ€ë¦½ ìœ ë„)
            2. ëŒ“ê¸€ ìœ ë„ ì ì¬ë ¥ (ì§ˆë¬¸í˜•, ê³µê°í˜•, ë°˜ë°•í˜•)
            3. íŒ©íŠ¸ ì‹ ë¢°ë„ (ì¶œì²˜ ëª…í™•, ê³¼ì¥ ì—†ìŒ)
            4. ì‹œì²­ í¥ë¯¸ (í›„í‚¹, ë°˜ì „, ê¶ê¸ˆì¦)

            ìœ„í—˜ ìš”ì†Œ:
            - clickbait: ë‚šì‹œì„± ì œëª©
            - unverified: ì¶œì²˜ ë¶ˆëª…í™•
            - controversial: ê³¼ë„í•œ ë…¼ìŸ ìœ ë°œ
            - outdated: ì‹œì˜ì„± ë¶€ì¡±

            ì¶œë ¥ í˜•ì‹ (JSON):
            {
              "verdict": "PASS or HOLD or DROP",
              "score": 0-10,
              "angle": "ë…¼ìŸìœ ë„í˜•/ì •ë³´ì œê³µí˜•/íŒ©íŠ¸ì²´í¬í˜•/íŠ¸ë Œë“œë¶„ì„í˜•",
              "reason": "íŒì • ê·¼ê±° 1-2ë¬¸ì¥",
              "risk_flags": ["clickbait", "unverified"],
              "must_include": ["ì¶œì²˜ì–¸ê¸‰", "ë°˜ë°•ê·¼ê±°"]
            }

            - PASS: 8-10ì , ìœ„í—˜ ìš”ì†Œ 1ê°œ ì´í•˜
            - HOLD: 6-7ì , ìˆ˜ì • í›„ ì¬ì‹¬ì‚¬ ê°€ëŠ¥
            - DROP: 0-5ì , ë¶€ì í•©
            """,
            board.getTitle(),
            board.getContent().substring(0, Math.min(500, board.getContent().length())),
            board.getSourceUrl(),
            preScore);

        String rawResponse = aiService.askGpt("", "", judgePrompt);

        try {
            // JSON íŒŒì‹±
            String jsonStr = rawResponse;
            if (rawResponse.contains("```json")) {
                jsonStr = rawResponse.substring(
                    rawResponse.indexOf("```json") + 7,
                    rawResponse.lastIndexOf("```")
                ).trim();
            } else if (rawResponse.contains("{")) {
                jsonStr = rawResponse.substring(
                    rawResponse.indexOf("{"),
                    rawResponse.lastIndexOf("}") + 1
                ).trim();
            }

            JsonNode root = objectMapper.readTree(jsonStr);

            String verdict = root.path("verdict").asText("DROP");
            int score = root.path("score").asInt(0);
            String angle = root.path("angle").asText("ì•Œ ìˆ˜ ì—†ìŒ");
            String reason = root.path("reason").asText("íŒŒì‹± ì‹¤íŒ¨");

            List<String> riskFlags = new ArrayList<>();
            if (root.has("risk_flags") && root.get("risk_flags").isArray()) {
                root.get("risk_flags").forEach(flag -> riskFlags.add(flag.asText()));
            }

            List<String> mustInclude = new ArrayList<>();
            if (root.has("must_include") && root.get("must_include").isArray()) {
                root.get("must_include").forEach(item -> mustInclude.add(item.asText()));
            }

            return JudgeResult.builder()
                    .verdict(verdict)
                    .score(score)
                    .angle(angle)
                    .reason(reason)
                    .riskFlags(riskFlags)
                    .mustInclude(mustInclude)
                    .preScore(preScore)
                    .build();

        } catch (Exception e) {
            log.error("âŒ LLM ì‹¬ì‚¬ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: {}", e.getMessage());
            // fallback: DROP
            return JudgeResult.builder()
                    .verdict("DROP")
                    .score(0)
                    .angle("íŒŒì‹±ì˜¤ë¥˜")
                    .reason("LLM ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: " + e.getMessage())
                    .riskFlags(List.of("parse_error"))
                    .mustInclude(List.of())
                    .preScore(preScore)
                    .build();
        }
    }
}